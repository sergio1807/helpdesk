<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Northgate Helpdesk 3.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(90deg, #004e92 0%, #000428 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .card-counter {
            box-shadow: 2px 2px 10px #DADADA;
            margin: 5px;
            padding: 20px 10px;
            background-color: #fff;
            height: 100px;
            border-radius: 5px;
            transition: .3s linear all;
        }

        .card-counter:hover {
            box-shadow: 4px 4px 20px #DADADA;
            transform: scale(1.02);
        }

        .card-counter i {
            font-size: 5em;
            opacity: 0.2;
            position: absolute;
            right: 15px;
            top: 15px;
        }

        .card-counter .count-numbers {
            position: absolute;
            right: 35px;
            top: 20px;
            font-size: 32px;
            display: block;
            font-weight: bold;
        }

        .card-counter .count-name {
            position: absolute;
            right: 35px;
            top: 65px;
            font-style: italic;
            text-transform: capitalize;
            opacity: 0.5;
            display: block;
            font-size: 18px;
        }

        .bg-primary-light {
            background-color: #e3f2fd;
            color: #0d6efd;
        }

        .badge-alta {
            background-color: #dc3545;
        }

        .badge-media {
            background-color: #ffc107;
            color: black;
        }

        .badge-baja {
            background-color: #198754;
        }

        .table-row-closed {
            opacity: 0.6;
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#"><i class="fas fa-rocket me-2"></i> Northgate Helpdesk</a>
            <span class="text-white small">GestiÃ³n de TI</span>
        </div>
    </nav>

    <div class="container">

        <div class="row mb-4 text-center">
            <div class="col-md-4">
                <div class="card-counter border-start border-4 border-warning">
                    <i class="fa fa-ticket-alt text-warning"></i>
                    <span class="count-numbers" id="count-abiertos">0</span>
                    <span class="count-name">Tickets Abiertos</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-counter border-start border-4 border-success">
                    <i class="fa fa-check-circle text-success"></i>
                    <span class="count-numbers" id="count-cerrados">0</span>
                    <span class="count-name">Tickets Cerrados</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-counter border-start border-4 border-primary">
                    <i class="fa fa-laptop text-primary"></i>
                    <span class="count-numbers" id="count-activos">0</span>
                    <span class="count-name">Total Activos</span>
                </div>
            </div>
        </div>

        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-tickets"><i
                        class="fas fa-list me-2"></i>Tickets</button>
            </li>
            <li class="nav-item ms-2">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-activos"><i
                        class="fas fa-server me-2"></i>Activos</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">

            <div class="tab-pane fade show active" id="pills-tickets">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-header bg-white fw-bold"><i class="fas fa-plus-circle me-1"></i> Nuevo
                                Ticket</div>
                            <div class="card-body">
                                <form id="ticketForm">
                                    <div class="mb-2">
                                        <label class="form-label small">Asunto</label>
                                        <input type="text" class="form-control" id="titulo" required>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small">Prioridad</label>
                                        <select class="form-select" id="prioridad">
                                            <option value="alta">ðŸ”´ Alta</option>
                                            <option value="media" selected>ðŸŸ¡ Media</option>
                                            <option value="baja">ðŸŸ¢ Baja</option>
                                        </select>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small">DescripciÃ³n</label>
                                        <textarea class="form-control" id="descripcion" rows="3" required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small">Activo (Opcional)</label>
                                        <select class="form-select" id="activoSelect">
                                            <option value="">Cargando...</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100"><i
                                            class="fas fa-paper-plane"></i> Crear</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <span class="fw-bold">Bandeja de Entrada</span>
                                <input type="text" id="buscador" class="form-control form-control-sm w-50"
                                    placeholder="ðŸ” Buscar ticket...">
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Detalle</th>
                                            <th>Activo</th>
                                            <th>Estado</th>
                                            <th class="text-end">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ticketTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-activos">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-header bg-white fw-bold"><i class="fas fa-laptop-medical me-1"></i> Nuevo
                                Activo</div>
                            <div class="card-body">
                                <form id="activoForm">
                                    <div class="mb-2"><input type="text" class="form-control" id="nomActivo"
                                            placeholder="Nombre (ej: Monitor)" required></div>
                                    <div class="mb-2"><input type="text" class="form-control" id="tipoActivo"
                                            placeholder="Tipo (ej: PerifÃ©rico)" required></div>
                                    <div class="mb-3"><input type="text" class="form-control" id="serActivo"
                                            placeholder="Serial (ej: NG-001)" required></div>
                                    <button type="submit" class="btn btn-success w-100"><i class="fas fa-save"></i>
                                        Guardar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card shadow-sm p-3">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Equipo</th>
                                        <th>Serial</th>
                                        <th class="text-end">AcciÃ³n</th>
                                    </tr>
                                </thead>
                                <tbody id="activosTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = window.location.origin + "/api";

        // --- CARGAR DATOS ---
        async function loadData() {
            // 1. Cargar Activos
            const resActivos = await fetch(API + '/activos');
            const activos = await resActivos.json();

            const actTable = document.getElementById('activosTable');
            const actSelect = document.getElementById('activoSelect');

            actTable.innerHTML = '';
            actSelect.innerHTML = '<option value="">Seleccione activo...</option>';
            document.getElementById('count-activos').innerText = activos.length;

            activos.forEach(a => {
                actSelect.innerHTML += `<option value="${a.id}">${a.nombre}</option>`;
                actTable.innerHTML += `
                    <tr>
                        <td>${a.id}</td>
                        <td>${a.nombre}<br><small class="text-muted">${a.tipo}</small></td>
                        <td><code>${a.serial}</code></td>
                        <td class="text-end"><button onclick="borrarActivo(${a.id})" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });

            // 2. Cargar Tickets
            const resTickets = await fetch(API + '/tickets');
            const tickets = await resTickets.json();
            renderTickets(tickets);
        }

        function renderTickets(tickets) {
            const tbody = document.getElementById('ticketTable');
            tbody.innerHTML = '';
            let abiertos = 0, cerrados = 0;

            tickets.forEach(t => {
                if (t.estado === 'abierto') abiertos++; else cerrados++;

                const badgePrio = t.prioridad === 'alta' ? 'badge-alta' : (t.prioridad === 'media' ? 'badge-media' : 'badge-baja');
                const rowClass = t.estado === 'cerrado' ? 'table-row-closed' : '';
                const btnAction = t.estado === 'abierto'
                    ? `<button onclick="cambiarEstado(${t.id}, 'cerrado')" class="btn btn-sm btn-success" title="Cerrar Ticket"><i class="fas fa-check"></i></button>`
                    : `<button onclick="cambiarEstado(${t.id}, 'abierto')" class="btn btn-sm btn-secondary" title="Reabrir Ticket"><i class="fas fa-undo"></i></button>`;

                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td>#${t.id}</td>
                        <td>
                            <div class="fw-bold">${t.titulo} <span class="badge ${badgePrio} rounded-pill" style="font-size:0.7em">${t.prioridad}</span></div>
                            <small class="text-muted">${t.descripcion}</small>
                        </td>
                        <td>${t.activo_nombre ? `<i class="fas fa-laptop text-primary"></i> ${t.activo_nombre}` : '-'}</td>
                        <td><span class="badge ${t.estado === 'abierto' ? 'bg-warning text-dark' : 'bg-secondary'}">${t.estado}</span></td>
                        <td class="text-end">
                            ${btnAction}
                            <button onclick="borrarTicket(${t.id})" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('count-abiertos').innerText = abiertos;
            document.getElementById('count-cerrados').innerText = cerrados;
        }

        // --- ACCIONES ---

        async function crearTicket(e) {
            e.preventDefault();
            const data = {
                titulo: document.getElementById('titulo').value,
                descripcion: document.getElementById('descripcion').value,
                prioridad: document.getElementById('prioridad').value,
                activo_id: document.getElementById('activoSelect').value || null
            };
            await fetch(API + '/tickets', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            document.getElementById('ticketForm').reset();
            Swal.fire('Â¡Listo!', 'Ticket creado', 'success');
            loadData();
        }

        async function crearActivo(e) {
            e.preventDefault();
            const data = {
                nombre: document.getElementById('nomActivo').value,
                tipo: document.getElementById('tipoActivo').value,
                serial: document.getElementById('serActivo').value
            };
            await fetch(API + '/activos', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            document.getElementById('activoForm').reset();
            Swal.fire('Â¡Listo!', 'Activo registrado', 'success');
            loadData();
        }

        async function cambiarEstado(id, nuevoEstado) {
            await fetch(`${API}/tickets/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ estado: nuevoEstado }) });
            loadData();
        }

        async function borrarTicket(id) {
            const result = await Swal.fire({ title: 'Â¿EstÃ¡s seguro?', text: "No podrÃ¡s revertir esto", icon: 'warning', showCancelButton: true, confirmButtonText: 'SÃ­, borrar' });
            if (result.isConfirmed) {
                await fetch(`${API}/tickets/${id}`, { method: 'DELETE' });
                loadData();
                Swal.fire('Borrado', 'El ticket ha sido eliminado', 'success');
            }
        }

        async function borrarActivo(id) {
            const result = await Swal.fire({ title: 'Â¿Borrar activo?', text: "Se eliminarÃ¡ si no tiene tickets asociados", icon: 'warning', showCancelButton: true });
            if (result.isConfirmed) {
                const res = await fetch(`${API}/activos/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadData();
                    Swal.fire('Borrado', 'Activo eliminado', 'success');
                } else {
                    Swal.fire('Error', 'No se puede borrar: tiene tickets asociados', 'error');
                }
            }
        }

        // Buscador simple en frontend
        document.getElementById('buscador').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#ticketTable tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        });

        // Listeners e Inicio
        document.getElementById('ticketForm').addEventListener('submit', crearTicket);
        document.getElementById('activoForm').addEventListener('submit', crearActivo);
        loadData();
    </script>
</body>

</html>