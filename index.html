<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Northgate Helpdesk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #0d6efd;
        }

        /* Azul Northgate */
        .card {
            margin-top: 20px;
            border: none;
            shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .table thead {
            background-color: #e9ecef;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#"> Northgate Helpdesk</a>
        </div>
    </nav>

    <div class="container">

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tickets-tab" data-bs-toggle="tab" data-bs-target="#tickets"
                    type="button"> Tickets</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="activos-tab" data-bs-toggle="tab" data-bs-target="#activos"
                    type="button"> Gesti贸n de Activos</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">

            <div class="tab-pane fade show active" id="tickets" role="tabpanel">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card p-3 shadow-sm">
                            <h5 class="card-title mb-3">Nuevo Ticket</h5>
                            <form id="ticketForm">
                                <div class="mb-3">
                                    <label class="form-label">Asunto</label>
                                    <input type="text" class="form-control" id="titulo" required
                                        placeholder="Ej: Fallo de red">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Descripci贸n</label>
                                    <textarea class="form-control" id="descripcion" rows="3" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Activo Relacionado</label>
                                    <select class="form-select" id="activoSelect">
                                        <option value="">Seleccione un activo (Opcional)</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Crear Ticket</button>
                            </form>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card p-3 shadow-sm">
                            <h5 class="card-title">Listado de Tickets</h5>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Asunto</th>
                                            <th>Activo</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ticketTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="activos" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="card p-3 shadow-sm">
                            <h5 class="card-title text-success">Registrar Activo</h5>
                            <form id="activoForm">
                                <div class="mb-3">
                                    <label class="form-label">Nombre del Equipo</label>
                                    <input type="text" class="form-control" id="nombreActivo" required
                                        placeholder="Ej: Laptop Dell XPS">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tipo</label>
                                    <select class="form-select" id="tipoActivo">
                                        <option>Laptop</option>
                                        <option>Monitor</option>
                                        <option>Impresora</option>
                                        <option>M贸vil</option>
                                        <option>Otro</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Serial / C贸digo</label>
                                    <input type="text" class="form-control" id="serialActivo" required
                                        placeholder="NG-2024-001">
                                </div>
                                <button type="submit" class="btn btn-success w-100">Guardar Activo</button>
                            </form>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card p-3 shadow-sm">
                            <h5 class="card-title">Inventario de Activos</h5>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Tipo</th>
                                        <th>Serial</th>
                                    </tr>
                                </thead>
                                <tbody id="activosTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = window.location.origin + "/api";

        // --- FUNCIONES DE CARGA ---

        async function loadTickets() {
            try {
                const res = await fetch(`${API_URL}/tickets`);
                const tickets = await res.json();
                const tbody = document.getElementById('ticketTable');
                tbody.innerHTML = '';

                if (tickets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay tickets registrados</td></tr>';
                    return;
                }

                tickets.forEach(t => {
                    const badgeClass = t.estado === 'abierto' ? 'bg-warning text-dark' : 'bg-success';
                    const row = `<tr>
                        <td><strong>${t.id}</strong></td>
                        <td>
                            <div class="fw-bold">${t.titulo}</div>
                            <small class="text-muted">${t.descripcion}</small>
                        </td>
                        <td>${t.activo_nombre ? `<span class="badge bg-info text-dark">${t.activo_nombre}</span>` : '<span class="text-muted">-</span>'}</td>
                        <td><span class="badge ${badgeClass}">${t.estado}</span></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error("Error cargando tickets:", error);
            }
        }

        async function loadActivos() {
            try {
                const res = await fetch(`${API_URL}/activos`);
                const activos = await res.json();

                // Llenar tabla de Activos
                const tbody = document.getElementById('activosTable');
                tbody.innerHTML = '';

                // Llenar Dropdown de Tickets
                const select = document.getElementById('activoSelect');
                select.innerHTML = '<option value="">Seleccione un activo (Opcional)</option>';

                activos.forEach(a => {
                    // Tabla
                    tbody.innerHTML += `<tr>
                        <td>${a.id}</td>
                        <td>${a.nombre}</td>
                        <td>${a.tipo}</td>
                        <td><code>${a.serial}</code></td>
                    </tr>`;

                    // Dropdown
                    select.innerHTML += `<option value="${a.id}">${a.nombre} (${a.serial})</option>`;
                });
            } catch (error) {
                console.error("Error cargando activos:", error);
            }
        }

        // --- EVENTOS DE FORMULARIOS ---

        // Crear Ticket
        document.getElementById('ticketForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const titulo = document.getElementById('titulo').value;
            const descripcion = document.getElementById('descripcion').value;
            const activo_id = document.getElementById('activoSelect').value || null; // Si est谩 vac铆o env铆a null

            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.textContent = "Guardando...";

            await fetch(`${API_URL}/tickets`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ titulo, descripcion, activo_id })
            });

            document.getElementById('ticketForm').reset();
            btn.disabled = false;
            btn.textContent = "Crear Ticket";
            loadTickets(); // Recargar lista inmediatamente
        });

        // Crear Activo
        document.getElementById('activoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('nombreActivo').value;
            const tipo = document.getElementById('tipoActivo').value;
            const serial = document.getElementById('serialActivo').value;

            await fetch(`${API_URL}/activos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, tipo, serial })
            });

            document.getElementById('activoForm').reset();
            loadActivos(); // Recargar lista y dropdown
            alert("Activo creado correctamente");
        });

        // Inicializar
        loadTickets();
        loadActivos();
    </script>
</body>

</html>